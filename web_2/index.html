<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Arnet Trace Viewer Pro - Telkom Kaliasem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-[#f8fafc] text-[#1e293b] min-h-screen font-sans">

    <header class="bg-white border-b border-slate-200 p-6 sticky top-0 z-50 shadow-sm">
        <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center space-x-4">
                <div class="w-2 h-10 bg-red-600 rounded-full"></div>
                <div>
                    <h1 class="text-2xl font-black tracking-tighter text-slate-900 uppercase">FastReporter <span class="text-red-600 font-light">Web-Lite</span></h1>
                    <p class="text-[10px] font-bold text-slate-400 tracking-[0.2em] uppercase">Arnet Backbone Kaliasem | Telkom Indonesia</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <input type="file" id="fileInput" class="hidden" accept=".sor">
                <label for="fileInput" class="bg-slate-900 hover:bg-red-600 text-white px-6 py-2.5 rounded-lg text-xs font-bold transition-all cursor-pointer shadow-lg active:scale-95 uppercase">
                    Buka File .SOR
                </label>
                <div id="status" class="text-[10px] font-mono bg-slate-100 px-3 py-2 rounded-md border border-slate-200 text-slate-500 uppercase font-bold italic">Ready</div>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-6 lg:p-10">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
            
            <div id="metaBox" class="hidden lg:block space-y-6 opacity-0 transition-opacity duration-500">
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-[11px] font-bold text-red-600 uppercase mb-6 tracking-widest border-b pb-2">Link Information</h2>
                    <div id="infoContent" class="space-y-4 font-mono text-xs">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-3">
                <div class="bg-white p-8 rounded-3xl border border-slate-200 shadow-xl relative min-h-[600px]">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                        <span class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.3em]">Optical Power Trace (dB)</span>
                        <div id="liveData" class="font-mono text-xs bg-red-50 text-red-600 px-4 py-2 rounded-full border border-red-100 font-bold shadow-inner">
                            Dist: 0.0000 km | Loss: 0.000 dB
                        </div>
                    </div>
                    
                    <div class="h-[450px] w-full">
                        <canvas id="otdrChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let myChart = null;

        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const st = document.getElementById('status');
            st.innerText = "Processing...";
            st.classList.add('text-red-500');

            const reader = new FileReader();
            reader.onload = (ev) => processSor(ev.target.result);
            reader.readAsArrayBuffer(file);
        });

        function processSor(buffer) {
            const dv = new DataView(buffer);
            const bytes = new Uint8Array(buffer);
            
            // 1. Cari Header 'DataPts'
            let offset = -1;
            const target = "DataPts";
            for (let i = 0; i < bytes.length - 7; i++) {
                if (String.fromCharCode(...bytes.slice(i, i + 7)) === target) {
                    offset = i; break;
                }
            }
            if (offset === -1) throw new Error("File .SOR tidak valid");

            // 2. Baca Jumlah Titik
            const numPoints = dv.getUint32(offset + 7, true);
            
            // 3. Cari Resolusi Jarak (FxpP)
            let spacing = 0.0001;
            for (let i = 0; i < bytes.length - 20; i++) {
                if (String.fromCharCode(...bytes.slice(i, i + 4)) === "FxpP") {
                    const res = dv.getInt32(i + 16, true);
                    const ior = 1.4682; // IOR Standard Telkom
                    spacing = (res * 149.896) / (ior * 1e6); 
                    break;
                }
            }

            // 4. Ekstrak Data
            let dataStart = offset + 16 + 11; // Offset standard Bellcore
            const points = [];
            
            // Sampling data agar tidak berat, tapi tetap presisi
            const step = Math.max(1, Math.floor(numPoints / 1500));

            for (let i = 0; i < numPoints; i += step) {
                const pos = dataStart + (i * 2);
                if (pos + 2 <= buffer.byteLength) {
                    const raw = dv.getUint16(pos, true);
                    const db = raw / 1000;
                    const km = i * spacing;
                    points.push({ x: km, y: db });
                }
            }

            // 5. Update UI & Render
            const mb = document.getElementById('metaBox');
            mb.classList.remove('hidden');
            mb.style.opacity = "1";
            document.getElementById('status').innerText = "SUCCESS";
            document.getElementById('infoContent').innerHTML = `
                <div class="flex justify-between border-b border-slate-50 pb-2">
                    <span class="text-slate-400 uppercase text-[10px]">Distance</span>
                    <span class="text-slate-900 font-bold">${points[points.length-1].x.toFixed(4)} KM</span>
                </div>
                <div class="flex justify-between border-b border-slate-50 pb-2">
                    <span class="text-slate-400 uppercase text-[10px]">Points</span>
                    <span class="text-slate-900 font-bold">${numPoints}</span>
                </div>
                <div class="mt-4 p-3 bg-slate-50 rounded-lg text-[10px] text-slate-500 italic leading-relaxed">
                    *Jarak dikalkulasi dengan IOR 1.4682 (G.652 Fiber).
                </div>
            `;

            renderChart(points);
        }

        function renderChart(dataPoints) {
            const ctx = document.getElementById('otdrChart').getContext('2d');
            if (myChart) myChart.destroy();

            // Auto-Normalizer Y Axis
            const yVals = dataPoints.map(d => d.y);
            const minY = Math.min(...yVals);
            const maxY = Math.max(...yVals);

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Power Trace',
                        data: dataPoints,
                        borderColor: '#dc2626',
                        borderWidth: 1.5,
                        pointRadius: 0,
                        fill: false,
                        tension: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 1000, easing: 'easeOutQuart' },
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        x: {
                            type: 'linear',
                            title: { display: true, text: 'Distance (Km)', font: { size: 10, weight: 'bold' } },
                            grid: { color: '#f1f5f9' },
                            ticks: { color: '#94a3b8', font: { size: 10 } }
                        },
                        y: {
                            reverse: true, // Persis EXFO: Loss ke bawah
                            title: { display: true, text: 'Loss (dB)', font: { size: 10, weight: 'bold' } },
                            grid: { color: '#f1f5f9' },
                            ticks: { color: '#94a3b8', font: { size: 10 } },
                            min: minY - 0.5,
                            max: maxY + 0.5
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    onHover: (e, el) => {
                        if (el.length > 0) {
                            const p = dataPoints[el[0].index];
                            document.getElementById('liveData').innerText = 
                                `Dist: ${p.x.toFixed(4)} km | Loss: ${p.y.toFixed(3)} dB`;
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>